<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>迁移 Linux 系统 - ZHB's Blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="zhb"><meta name=description content="最近入了一块 1TB 的固态，然后把原来安装在 256GB PM981 上的 Manjaro 系统迁移到了新的固态上。此文记录一下大致的迁移过程。"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.79.0 with theme even"><link rel=canonical href=https://blog.gkzhb.tk/post/migrate-linux/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="迁移 Linux 系统"><meta property="og:description" content="最近入了一块 1TB 的固态，然后把原来安装在 256GB PM981 上的 Manjaro 系统迁移到了新的固态上。此文记录一下大致的迁移过程。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.gkzhb.tk/post/migrate-linux/"><meta property="article:published_time" content="2020-12-13T22:52:28+08:00"><meta property="article:modified_time" content="2020-12-13T22:52:28+08:00"><meta itemprop=name content="迁移 Linux 系统"><meta itemprop=description content="最近入了一块 1TB 的固态，然后把原来安装在 256GB PM981 上的 Manjaro 系统迁移到了新的固态上。此文记录一下大致的迁移过程。"><meta itemprop=datePublished content="2020-12-13T22:52:28+08:00"><meta itemprop=dateModified content="2020-12-13T22:52:28+08:00"><meta itemprop=wordCount content="1786"><meta itemprop=keywords content="linux,配置,"><meta name=twitter:card content="summary"><meta name=twitter:title content="迁移 Linux 系统"><meta name=twitter:description content="最近入了一块 1TB 的固态，然后把原来安装在 256GB PM981 上的 Manjaro 系统迁移到了新的固态上。此文记录一下大致的迁移过程。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>ZHB's Blog</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>ZHB's Blog</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>迁移 Linux 系统</h1><div class=post-meta><span class=post-time>2020-12-13</span><div class=post-category><a href=/categories/linux/>linux</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#流程>流程</a></li><li><a href=#创建分区>创建分区</a></li><li><a href=#复制-linux-系统根目录到新分区>复制 Linux 系统根目录到新分区</a><ul><li><a href=#挂载新分区>挂载新分区</a></li><li><a href=#使用-rsync-复制分区>使用 rsync 复制分区</a></li></ul></li><li><a href=#修改-etcfstab>修改 /etc/fstab</a></li><li><a href=#安装-grub-引导>安装 GRUB 引导</a></li><li><a href=#efibootmgr-添加-efi-启动项>efibootmgr 添加 EFI 启动项</a><ul><li><a href=#查看当前启动项序列>查看当前启动项序列</a></li><li><a href=#修改-efi-启动项时遇到的问题>修改 EFI 启动项时遇到的问题</a></li><li><a href=#添加-efi-启动项>添加 EFI 启动项</a></li><li><a href=#删除-efi-启动项>删除 EFI 启动项</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=post-content><p>最近入了一块 1TB 的固态，然后把原来安装在 256GB PM981 上的 Manjaro 系统迁移到了新的固态上。此文记录一下大致的迁移过程。</p><h2 id=流程>流程</h2><blockquote><p>本篇中我使用的是 UEFI 引导 + GPT 分区</p></blockquote><ol><li>在新的硬盘上创建好分区</li><li>在 Linux 系统中挂载创建的分区</li><li>使用 <code>rsync</code> 命令将 Linux 根目录同步到新分区中</li><li>修改 <code>/etc/fstab</code> 中分区对应的 UUID</li><li>为新硬盘安装 GRUB 引导</li><li>若 BIOS 中没有显示对应的启动项，需要通过 <code>efibootmgr</code> 命令手动添加 EFI 启动项</li></ol><h2 id=创建分区>创建分区</h2><p>初始空硬盘格式化为 GPT 格式。之后在硬盘中依次创建 EFI 分区、Linux Swap 分区和 ext4 分区。</p><p>我使用的软件是 Linux 上的 Gparted，在 Win 上有很多磁盘管理软件，如 Disk Genius 等。</p><ul><li>EFI 分区：文件系统格式为 FAT32，我分配了 550MB 空间，分区的标志位（Flags）设置 <code>boot</code> 和 <code>esp</code></li><li>Linux Swap 分区：我设置成运行内存的大小 16GB</li><li>ext4 分区：Linux 系统根目录挂载的分区，根据需要划分大小</li></ul><h2 id=复制-linux-系统根目录到新分区>复制 Linux 系统根目录到新分区</h2><h3 id=挂载新分区>挂载新分区</h3><p>在 Linux 上，挂载（需要 Root 权限）新的 ext4 分区到某个目录（<code>/mnt/ssd</code>）中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>mount /dev/nvme1n1p3 /mnt/ssd
</code></pre></td></tr></table></div></div><p>需要查看分区设备号（<code>/dev/xxxpx</code>），可以用以下命令（同样需要 Root 权限）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>fdisk -l
</code></pre></td></tr></table></div></div><h3 id=使用-rsync-复制分区>使用 rsync 复制分区</h3><p>使用 <code>rsync</code> 复制 Linux 系统到新分区上（同样需要 Root 权限）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>rsync -a -x / /mnt/ssd
</code></pre></td></tr></table></div></div><p>这个过程时间可能会比较长，请耐心等待。要说明的一点是，命令中 <code>-x</code> 参数让 <code>rsync</code> 只会复制根目录对应的分区中的文件内容，即根目录下挂载的其它分区不会被复制。而且像 <code>/proc</code>、<code>/sys</code> 这些运行时产生的文件系统和如 <code>/tmp</code>，<code>/dev/shm</code> 等内存中的文件系统也不会被复制。</p><p>所以如果 Linux 系统有不止一个分区需要迁移，需要对其它分区也做 <code>rsync</code> 复制，否则它们是不会被复制到新分区中的。</p><p>关于 <code>-x</code> 参数的具体解释说明可以查看这个链接：<a href=https://unix.stackexchange.com/questions/107113/meaning-of-crossing-filesystem-boundaries-one-file-system-etc>backup - Meaning of Crossing filesystem boundaries, &ndash;one-file-system, etc - Unix & Linux Stack Exchange</a></p><h2 id=修改-etcfstab>修改 /etc/fstab</h2><p>在 <code>/etc/fstab</code> 文件中（挂载分区中对应 <code>/mnt/ssd/etc/fstab</code>），记录了各个路径点对应的挂载分区，一般使用 UUID 识别某个分区。</p><p>使用以下命令（需要 Root 权限）查看分区对应的 UUID：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>lsblk -o+UUID
</code></pre></td></tr></table></div></div><table><thead><tr><th style=text-align:center>分区</th><th>挂载点</th></tr></thead><tbody><tr><td style=text-align:center>EFI 分区</td><td><code>/boot/efi</code></td></tr><tr><td style=text-align:center>Linux Swap</td><td><code>swap</code></td></tr><tr><td style=text-align:center>ext4 分区</td><td><code>/</code></td></tr></tbody></table><p>只要将<strong>新分区</strong>中的 fstab 文件中 <code>UUID=</code> 后面的 UUID 进行替换即可，挂载点不用修改。</p><h2 id=安装-grub-引导>安装 GRUB 引导</h2><p>首先将新硬盘中的 EFI 分区挂载到 <code>/mnt/ssd/boot/efi</code> 路径点上，然后使用 <code>chroot</code> 命令（Root 权限）切换根目录到新硬盘中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>chroot /mnt/ssd
</code></pre></td></tr></table></div></div><p>然后使用命令更新 GRUB 引导：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>update-grub
</code></pre></td></tr></table></div></div><p>之后如果重启能够在 BIOS 中找到 EFI 启动项并成功启动就没问题了（当然我并没有这么幸运）。如果不行可以尝试安装 GRUB：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>grub-install /dev/nvme1n1
</code></pre></td></tr></table></div></div><p>这里参数为<strong>新硬盘的设备号</strong>而不是分区的。</p><p>这个方法对我也行不通。所以我需要通过 <code>efibootmgr</code> 手动添加 EFI 启动项。</p><h2 id=efibootmgr-添加-efi-启动项>efibootmgr 添加 EFI 启动项</h2><p>efibootmgr 的使用推荐大家去看 <a href=https://wiki.gentoo.org/wiki/Efibootmgr>Gentoo Wiki</a>。</p><p>efibootmgr 命令也需要 Root 权限。</p><h3 id=查看当前启动项序列>查看当前启动项序列</h3><p>使用 <code>-v</code> 参数查看当前启动项序列：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>efibootmgr -v
</code></pre></td></tr></table></div></div><p>你可以看看当前 Linux 系统启动项的 EFI 启动文件路径。比如我的显示如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>Boot0001* Manjaro       HD(1,GPT,d0c6347f-32c0-441b-a898-b6498069b46c,0x3f,0x967c1)/File(\EFI\Manjaro\grubx64.efi)
</code></pre></td></tr></table></div></div><p>只需要关心 <code>File</code> 后面的路径（这里路径分隔符使用<strong>反斜线</strong> <code>\</code> 而不是普通的斜线 <code>/</code> 请注意），之后创建 EFI 启动项的时候会用到。另外这个路径不区分大小写（FAT32 分区的锅），所以写成全大写或全小写应该也是没问题的。</p><h3 id=修改-efi-启动项时遇到的问题>修改 EFI 启动项时遇到的问题</h3><p>之后修改 EFI 配置的时候，我遇到个问题：每次设置完用 efibootmgr 命令查看显示成功，但是重启进入 BIOS 却没有。之后找到<a href=https://superuser.com/questions/1166398/efi-settings-set-via-efibootmgr-are-ignored-after-reboot>这个解决方案</a>（最后一个回答，被人踩了但确实解决了我的问题）。解决方法是重新挂载 efivarfs 分区（在 <a href=https://wiki.gentoo.org/wiki/Efibootmgr>Gentoo Wiki</a> 中有提到）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>mount -o remount,rw -t efivarfs efivarfs /sys/firmware/efi/efivars
</code></pre></td></tr></table></div></div><p>所以在修改 EFI 配置之前建议先执行上面的命令。</p><h3 id=添加-efi-启动项>添加 EFI 启动项</h3><p>创建 EFI 启动项：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>efibootmgr -c -d /dev/nvme1n1 -p <span class=m>1</span> -L <span class=s2>&#34;Manjaro&#34;</span> -l <span class=s2>&#34;\EFI\Manjaro\grubx64.efi&#34;</span>
</code></pre></td></tr></table></div></div><p>上面命令中</p><ul><li><code>-c</code> 表示创建 EFI 启动项</li><li><code>-d</code> 提供硬盘设备号，<code>-p</code> 提供 EFI 分区在硬盘的第几个分区，如 EFI 对应设备号为 <code>/dev/nvme1n1p1</code> 最后一个数字 <code>1</code> 就对应分区数（计数从 1 开始不是从 0 开始）</li><li><code>-L</code> 提供 EFI 启动项的标识文字，即在 BIOS 中看到的启动项名称</li><li><code>-l</code> 指定启动项执行的文件，就是之前记录的那个路径。可以去检查一下这个文件是否存在，如我的文件路径为 <code>.../boot/efi/EFI/Manjaro/grubx64.efi</code></li></ul><p>成功执行之后应该会输出添加后的所有 EFI 启动项。</p><h3 id=删除-efi-启动项>删除 EFI 启动项</h3><blockquote><p>确定成功启动之前请务必不要删除原来的 EFI 启动项</p></blockquote><p>删除使用 <code>-B</code> 参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>efibootmgr -b <span class=m>2</span> -B
</code></pre></td></tr></table></div></div><p><code>-b</code> 表示要删除的启动项的编号，即通过 <code>-v</code> 参数看到的，如 <code>Boot0001</code> 编号就是 1。这个编号是十六进制的，按照 <code>Boot</code> 后面的内容输入即可。</p><h2 id=总结>总结</h2><p>最后说些题外话，曾经我也尝试用 efibootmgr 修复 EFI 引导成功过，而且当时似乎也遇到过同样地问题，但是现在不记得以前的步骤了。当初可能是碰对的感觉，现在又踩了一遍坑。</p><p>总结下经验：</p><ol><li>这些莫名其妙的 bug 还是要弄清楚为好，不然之后碰到还要浪费时间</li><li>踩过的坑最好能记录下解决方法，之后可以参考</li></ol><h2 id=参考>参考</h2><ul><li><a href=https://askubuntu.com/questions/741723/moving-entire-linux-installation-to-another-drive>backup - Moving entire Linux installation to another drive - Ask Ubuntu</a></li><li><a href=https://askubuntu.com/questions/88384/how-can-i-repair-grub-how-to-get-ubuntu-back-after-installing-windows/88432#88432>dual boot - How can I repair grub? (How to get Ubuntu back after installing Windows?) - Ask Ubuntu</a></li><li><a href=https://wiki.gentoo.org/wiki/Efibootmgr>Efibootmgr - Gentoo Wiki</a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/linux/>linux</a>
<a href=/tags/%E9%85%8D%E7%BD%AE/>配置</a></div><nav class=post-nav><a class=next href=/post/revealjs/><span class="next-text nav-default">用 Hugo 与 Markdown 制作网页 PPT</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:zhb896579388@163.com class="iconfont icon-email" title=email></a><a href=https://github.com/gkzhb class="iconfont icon-github" title=github></a><a href=https://blog.gkzhb.tk/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2019 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>zhb</span></span></div><div class=copyright><span>本网站由<a class=sponsors href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" rel=noopener target=_blank>
<img src=/upyun_logo.png style=width:auto;height:35px>
</a>提供 CDN 加速/云存储服务</span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/dist/even.26188efa.min.js></script></body></html>